<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Urban Sociology Obsidian Vault</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Vis.js for graph visualization -->
  <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
  <header>
    <nav class="site-nav">
      <a href="index.html">Home</a>
      <a href="downloads.html">Downloads</a>
    </nav>
    <h1>Urban Sociology Notes and Graph View</h1>
    <p>ISS320 Study Tool v1</p>
  </header>

  <main>
    <section id="graph-section">
      <h2>Graph View</h2>
      <div id="graph-container"></div>
    </section>

    <section id="notes-section">
      <h2>Notes List</h2>
      <input type="text" id="notes-search" placeholder="Search notes..." aria-label="Search notes">
      <ul id="notes-list"></ul>
    </section>

    <section id="note-viewer">
      <h2>Note Viewer</h2>
      <div id="note-content"></div>
    </section>
  </main>

  <footer>
    <p>D. Gramm</p>
  </footer>

  <script>
    const noteFiles = [
      'Author - Le Corbusier.md',
      'Author - Lewis Mumford.md',
      'Author - Jane Jacobs.md',
      'Author - Ferdinand Tönnies.md',
      'Author - Georg Simmel.md',
      'Reading - corbusier.pdf.md',
      'Reading - Mumford What is a City Legates City Reader.pdf.md',
      'Reading - jacobs.pdf.md',
      'Reading - toennies.pdf.md',
      'Reading - simmel.pdf.md',
      'Reading - studyguide2.pdf.md',
      'Reading - readings1-2.pdf.md',
      'Concept - Abstraction-Standardization.md',
      'Concept - Atomization.md',
      'Concept - Binary Opposition.md',
      'Concept - Blasé.md',
      'Concept - Calculative Rationality.md',
      'Concept - Cardo Maximus.md',
      'Concept - Core.md',
      'Concept - Cultural Essentialism.md',
      'Concept - Decumanus.md',
      'Concept - Division of Labor.md',
      'Concept - Economic Determinism.md',
      'Concept - Gemeinschaft.md',
      'Concept - Gesellschaft.md',
      'Concept - Haussmannization.md',
      'Concept - Hegemony.md',
      'Concept - Human Nature.md',
      'Concept - Ideal Type.md',
      'Concept - Intellect.md',
      'Concept - Materialism.md',
      'Concept - Means of Production.md',
      'Concept - Mode of Production.md',
      'Concept - Modernization Theory.md',
      'Concept - Money Economy.md',
      'Concept - Objective Spirit.md',
      'Concept - Periphery.md',
      "Concept - Prisoner's Dilemma.md",
      'Concept - Prosthetic.md',
      'Concept - Relational History.md',
      'Concept - Reserve.md',
      'Concept - Semi Periphery.md',
      'Concept - Social Engineering.md',
      'Concept - State of Nature.md',
      'Concept - Subjective Spirit.md',
      'Concept - Telos.md',
      'Concept - The Enlightenment.md',
      'Concept - Utopia.md',
      "Concept - Man's Way.md",
      "Concept - Pack-Donkey's Way.md",
      'Concept - Theater of Social Action.md',
      'Concept - Social Drama.md',
      'Concept - Eyes on the Street.md',
      'Concept - Street Ballet.md'
    ];

    async function buildGraph() {
      const nodes = new vis.DataSet();
      const edges = new vis.DataSet();
      const noteMap = new Map();
      const contentMap = new Map();

      const results = await Promise.all(
        noteFiles.map(file =>
          fetch('notes/' + encodeURIComponent(file))
            .then(r => r.ok ? r.text() : null)
            .then(content => ({ file, content }))
        )
      );
      let id = 1;
      for (const { file, content } of results) {
        if (content != null) {
          nodes.add({ id: id, label: file.replace('.md', '') });
          noteMap.set(file, id);
          contentMap.set(file, content);
          id++;
        }
      }

      for (const [file, content] of contentMap) {
        const fromId = noteMap.get(file);
        const links = content.match(/\[\[([^\]]+)\]\]/g) || [];
        for (const link of links) {
          const target = link.slice(2, -2).trim() + '.md';
          const targetId = noteMap.get(target);
          if (targetId && fromId) edges.add({ from: fromId, to: targetId });
        }
      }

      const container = document.getElementById('graph-container');
      if (nodes.length === 0) {
        container.innerHTML = '<p>No notes loaded. Add .md files to the notes folder.</p>';
        return;
      }
      const idToFile = new Map();
      noteMap.forEach((nodeId, file) => { idToFile.set(nodeId, file); });
      const data = { nodes, edges };
      const options = {
        layout: { hierarchical: false },
        physics: { enabled: true },
        nodes: {
          shape: 'dot',
          size: 10,
          color: {
            background: '#E30613',
            border: '#111',
            highlight: { background: '#ff3d4d', border: '#111' },
            hover: { background: '#ff3d4d', border: '#111' }
          }
        },
        edges: {
          arrows: 'to',
          color: { color: '#E30613', highlight: '#ff3d4d', hover: '#ff3d4d' }
        }
      };
      const network = new vis.Network(container, data, options);
      network.on('doubleClick', function(params) {
        if (params.nodes.length > 0) {
          const file = idToFile.get(params.nodes[0]);
          if (file) loadNote(file);
        }
      });
    }

    function listNotes() {
      const ul = document.getElementById('notes-list');
      const query = (document.getElementById('notes-search').value || '').trim().toLowerCase();
      const filtered = query
        ? noteFiles.filter(f => f.replace('.md', '').toLowerCase().includes(query))
        : noteFiles;
      ul.innerHTML = '';
      filtered.forEach(file => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = file.replace('.md', '');
        a.onclick = (e) => { e.preventDefault(); loadNote(file); };
        li.appendChild(a);
        ul.appendChild(li);
      });
    }

    document.getElementById('notes-search').addEventListener('input', listNotes);

    async function loadNote(file) {
      const response = await fetch('notes/' + encodeURIComponent(file));
      const el = document.getElementById('note-content');
      if (response.ok) {
        const markdown = await response.text();
        el.innerHTML = typeof marked !== 'undefined' ? marked.parse(markdown) : markdown;
      } else {
        el.innerHTML = '<p>Note not found.</p>';
      }
    }

    buildGraph();
    listNotes();
  </script>
</body>
</html>
